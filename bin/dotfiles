#!/usr/bin/env bash

# Variables
# ========================================================

# Dotfiles directory (With default value if first install)
[[ -d "$DOTFILES_PATH"  ]] && DOTFILES_DIR="$(readlink -e "$(dirname "$0")/..")" || DOTFILES_DIR="$HOME/.dotfiles"

BASH_COMPLETION_DIR="/etc/bash_completion.d"
BACKUP_DIR="$DOTFILES_DIR/backup"
SUBLIMETEXT_CONF_DIR="$HOME/.config/sublime-text-3/Packages/User"
I3_CONFIG_FILE="$HOME/.i3/config"
SSHRC_CONFIG_FILE="$HOME/.sshrc"
FZF_DIR="$DOTFILES_DIR/fzf"

# Colors
_TXTCOLOR_RED=$(tput setaf 1)
_TXTCOLOR_GREEN=$(tput setaf 2)
_TXTCOLOR_YELLOW=$(tput setaf 3)
_TXTCOLOR_BLUE=$(tput setaf 4)
# _TXTCOLOR_MAGENTA=$(tput setaf 5)
# _TXTCOLOR_CYAN=$(tput setaf 6)
_TXTCOLOR_RESET=$(tput sgr0)

# Functions
# ========================================================

# Echos
# --------------------------------------------------------
echo_header() {   echo -e "\n${_TXTCOLOR_BLUE}⦿ $@${_TXTCOLOR_RESET}"; }
echo_success() {  echo "    ${_TXTCOLOR_GREEN}✔${_TXTCOLOR_RESET} $@"; }
echo_info() {     echo "    ${_TXTCOLOR_BLUE}➤${_TXTCOLOR_RESET} $@"; }
echo_warning() {  echo "    ${_TXTCOLOR_YELLOW}⚠${_TXTCOLOR_RESET} $@"; }
echo_error() {    echo "    ${_TXTCOLOR_RED}✖${_TXTCOLOR_RESET} $@"; }

# Echos with alignment
# --------------------------------------------------------
print_success() {  printf "    ${_TXTCOLOR_GREEN}✔${_TXTCOLOR_RESET} %-20s %s \n" "$1" "${*:2}"; }
print_info() {     printf "    ${_TXTCOLOR_BLUE}➤${_TXTCOLOR_RESET} %-20s %s \n" "$1" "${*:2}"; }
print_warning() {  printf "    ${_TXTCOLOR_YELLOW}⚠${_TXTCOLOR_RESET} %-20s %s \n" "$1" "${*:2}"; }

# Make a symlink (backup if destination exist)
# -------------------------------------------------------
make_symlink() {
	local dot_file_path="$1"
	local file_path="$2"
	local file_name=$(basename "$file_path")

	# With sudo ?
	[[ "$3" == "sudo"  ]] && local with_sudo="sudo " || with_sudo=""

	if [[ ! -d "$BACKUP_DIR" ]]; then
		echo_error "Backup directory $BACKUP_DIR doesn\'t exist"
		exit 2
	fi

	# If file_path is not already a symlink or doesn't exist
	if [[ ! -L "$file_path" ]]; then

		# File or directory already exist, make backup
		if [[ -f "$file_path" ]] || [[ -d "$file_path" ]]; then
			print_warning "$file_name" "Backup in $BACKUP_DIR/$file_name.bak"
			${with_sudo} mv "$file_path" "$BACKUP_DIR/$file_name.bak"
		fi

		# Make symlink
		print_success "$file_name" "symlink ➜ $file_path"
		${with_sudo} ln -s --force "$dot_file_path" "$file_path"
	else
		print_info "$file_name" "already installed"
	fi
}

# Create directory if necessary
# --------------------------------------------------------
dir_check() {
	local dir_path="$1"
	if [[ ! -d "$dir_path" ]]; then
		mkdir -p "$dir_path"
	fi
}

# Check for 404 and download a ressource (if file age > 7 days)
# --------------------------------------------------------
download_if_available() {
	local DOWNLOAD_URL="$1"
	local DESTINATION="$2"

	# Check file age
	if file_is_fresh "$DESTINATION" ; then
		print_info "$(basename "$DOWNLOAD_URL")" "downloaded recently"
		return 0
	else
		print_info $(basename "$DOWNLOAD_URL") "download"
		if [[ $(curl -o /dev/null --silent --head --write-out '%{http_code}' "${DOWNLOAD_URL}") == 200 ]]; then
			curl -sS "$DOWNLOAD_URL" -o "$DESTINATION"
			print_success "$(basename "$DOWNLOAD_URL")" "$DESTINATION"
			return 0
		else
			echo_error "$DOWNLOAD_URL isn't available"
			return  1
		fi
	fi
}

# Clone if doesn't exist, else update
# --------------------------------------------------------
clone_or_update() {
	local git_url="$1"
	local install_path="$2"
	local depot_name=$(basename "$install_path")

	if [[ -d "$install_path" ]]; then
		# Update if folder older than 7 day
		if file_is_fresh "$install_path" ; then
			print_info "$depot_name" "updated recently"
		else
			print_info "$depot_name" "update"
			( cd "$install_path" && git pull --quiet origin master )
		fi
	else
		# Clone
		print_success "$depot_name" "install"
		git clone --quiet "$git_url" "$install_path"
	fi
}

# Check if file is older than x days (default 7)
# --------------------------------------------------------
file_is_fresh() {
	local file="$1"
	local agemax=$((${2:-7} * 60 * 60 * 24))

	if [[ -e "$file" ]]; then
		local agefile=$(($(date +%s) - $(stat -c '%Y' "$file")))
		if [[ "$agefile" -lt "$agemax" ]]; then
			return 0
		fi
	fi

	return 1
}

# Install
# ========================================================

# Requirements
# --------------------------------------------------------
if [[ ! -x "$(which git 2>/dev/null)" ]]; then
	echo_error "Git is missing. Aborting."
	exit 1
fi

# Clone or update dotfiles
# --------------------------------------------------------
if [[ "$1" == "scriptrestart" ]]; then
	echo_header "Dotfiles updated"
else
	echo_header "Dotfiles"
fi

if [[ ! -d "$DOTFILES_DIR" ]]; then
	# $DOTFILES_DIR directory doesn't exist? Clone it!
	print_success "Dotfiles" "install"
	git clone --quiet "https://github.com/Silvus/dotfiles.git" $DOTFILES_DIR
elif [[ "$1" != "scriptrestart" ]]; then
	# Make sure we have the latest files
	print_info "Dotfiles" "update"
	prev_head="$(cd "$DOTFILES_DIR" && git rev-parse HEAD)"
	( cd "$DOTFILES_DIR" && git pull --quiet origin master )
	if [[ "$(cd "$DOTFILES_DIR" && git rev-parse HEAD)" != "$prev_head" ]]; then
		# Need a restart
		print_success "Dotfiles" "updated, restarting script"
		exec "$0" "scriptrestart"
	fi
fi

# Bash
# --------------------------------------------------------
echo_header "Bash"
make_symlink "$DOTFILES_DIR/bash/bash_aliases" "$HOME/.bash_aliases"
make_symlink "$DOTFILES_DIR/bash/completion/sshrc" "$BASH_COMPLETION_DIR/sshrc" "sudo"
make_symlink "$DOTFILES_DIR/bash/completion/dev" "$BASH_COMPLETION_DIR/dev" "sudo"

# Git
# --------------------------------------------------------
echo_header "Git"
make_symlink "$DOTFILES_DIR/git/gitignore_global" "$HOME/.gitignore_global"

# Vim
# --------------------------------------------------------
if [[ -x "$(which vim 2>/dev/null)" ]]; then
	echo_header "Vim"
	dir_check "$HOME/.vim/backup"
	dir_check "$HOME/.vim/swap"
	dir_check "$HOME/.vim/undo"
	dir_check "$HOME/.vim/colors"
	dir_check "$HOME/.vim/autoload"
	dir_check "$HOME/.vim/bundle"
	dir_check "$HOME/.vim/conf"
	# Colors
	make_symlink "$DOTFILES_DIR/vim/colors/jellybeans.vim" "$HOME/.vim/colors/jellybeans.vim"

	# Conf
	make_symlink "$DOTFILES_DIR/vim/vimrc" "$HOME/.vimrc"
	make_symlink "$DOTFILES_DIR/vim/vimrc_sec" "$HOME/.vim/.vimrc_sec"
	make_symlink "$DOTFILES_DIR/vim/vimrc_ide" "$HOME/.vim/.vimrc_ide"
	make_symlink "$DOTFILES_DIR/vim/vimrc_sshrc" "$HOME/.sshrc.d/.vimrc"
	# Conf parts
	make_symlink "$DOTFILES_DIR/vim/conf/vim_base" "$HOME/.vim/conf/vim_base"
	make_symlink "$DOTFILES_DIR/vim/conf/vim_keymaps" "$HOME/.vim/conf/vim_keymaps"
	make_symlink "$DOTFILES_DIR/vim/conf/vim_plugins" "$HOME/.vim/conf/vim_plugins"
	make_symlink "$DOTFILES_DIR/vim/conf/vim_theme" "$HOME/.vim/conf/vim_theme"

	# Vim plugins
	echo_header "Vim plugins"
	# Pathogen
	download_if_available "https://raw.githubusercontent.com/tpope/vim-pathogen/master/autoload/pathogen.vim" "$HOME/.vim/autoload/pathogen.vim"
	clone_or_update "https://github.com/kien/ctrlp.vim.git" "$HOME/.vim/bundle/ctrlp"
	clone_or_update "https://github.com/bling/vim-airline.git" "$HOME/.vim/bundle/vim-airline"
	clone_or_update "https://github.com/scrooloose/syntastic.git" "$HOME/.vim/bundle/syntastic"
	clone_or_update "https://github.com/Raimondi/delimitMate.git" "$HOME/.vim/bundle/delimitMate"
	clone_or_update "https://github.com/tpope/vim-commentary.git" "$HOME/.vim/bundle/vim-commentary"
	clone_or_update "https://github.com/Shougo/neocomplcache.vim.git" "$HOME/.vim/bundle/neocomplcache.vim"
	clone_or_update "https://github.com/fatih/vim-go.git" "$HOME/.vim/bundle/vim-go"
	clone_or_update "https://github.com/scrooloose/nerdtree.git" "$HOME/.vim/bundle/nerdtree"
	clone_or_update "https://github.com/tpope/vim-fugitive.git" "$HOME/.vim/bundle/vim-fugitive"
	clone_or_update "https://github.com/airblade/vim-gitgutter.git" "$HOME/.vim/bundle/vim-gitgutter"
fi

# Tmux
# --------------------------------------------------------
if [[ -x "$(which tmux 2>/dev/null)" ]]; then
	echo_header "Tmux"
	make_symlink "$DOTFILES_DIR/tmux/tmux.conf" "$HOME/.tmux.conf"
fi

# PHP
# --------------------------------------------------------
if [[ -x "$(which php 2>/dev/null)" ]]; then
	echo_header "PHP"
	# Composer
	download_if_available "https://getcomposer.org/composer.phar" "$DOTFILES_DIR/bin/composer"
	chmod 770 "$DOTFILES_DIR/bin/composer"
	make_symlink "$DOTFILES_DIR/bash/completion/composer" "$BASH_COMPLETION_DIR/composer" "sudo"
fi

# Go
# --------------------------------------------------------
if [[ -x "$(which go 2>/dev/null)" ]]; then
	# Completion
	echo_header "Go"
	make_symlink "$DOTFILES_DIR/bash/completion/go" "$BASH_COMPLETION_DIR/go" "sudo"
fi

# SSHRC
# --------------------------------------------------------
echo_header "SSHRC"
download_if_available "https://raw.githubusercontent.com/Russell91/sshrc/master/sshrc" "$DOTFILES_DIR/bin/sshrc"
chmod 770 "$DOTFILES_DIR/bin/sshrc"

# sshrc.d
dir_check "$HOME/.sshrc.d"

# Generated sshrc config
print_success "sshrc config" "generated"
echo -e "# DO NOT EDIT THIS FILE BY HAND.\n# YOUR CHANGES WILL BE OVERWRITTEN !\n" > "$SSHRC_CONFIG_FILE"
cat "$DOTFILES_DIR/sshrc/sshrc_main" >> "$SSHRC_CONFIG_FILE"
cat "$DOTFILES_DIR/bash/aliases/01_main.bash" >> "$SSHRC_CONFIG_FILE"
cat "$DOTFILES_DIR/bash/aliases/04_prompt.bash" >> "$SSHRC_CONFIG_FILE"
cat "$DOTFILES_DIR/sshrc/sshrc_ascii" >> "$SSHRC_CONFIG_FILE"

# Fzf
# --------------------------------------------------------
echo_header "Fzf"
if [[ ! -d "$FZF_DIR" ]]; then
	clone_or_update "https://github.com/junegunn/fzf.git" "$FZF_DIR"
	"${FZF_DIR}/install"
else
	clone_or_update "https://github.com/junegunn/fzf.git" "$FZF_DIR"
fi

# Lynx
# --------------------------------------------------------
if [[ -x "$(which lynx 2>/dev/null)" ]]; then
	echo_header "Lynx"
	dir_check "$HOME/.lynx"
	make_symlink "$DOTFILES_DIR/lynx/lynxrc" "$HOME/.lynx/.lynxrc"
	make_symlink "$DOTFILES_DIR/lynx/lynx.lss" "$HOME/.lynx/lynx.lss"
	make_symlink "$DOTFILES_DIR/lynx/lynx_bookmarks.html" "$HOME/.lynx/lynx_bookmarks.html"
fi

# Ranger
# --------------------------------------------------------
if [[ -x "$(which ranger 2>/dev/null)" ]]; then
	echo_header "Ranger"
	dir_check "$HOME/.config/ranger"
	make_symlink "$DOTFILES_DIR/ranger/rc.conf" "$HOME/.config/ranger/rc.conf"
	make_symlink "$DOTFILES_DIR/ranger/rifle.conf" "$HOME/.config/ranger/rifle.conf"
fi

# MOC
# --------------------------------------------------------
if [[ -x "$(which mocp 2>/dev/null)" ]]; then
	echo_header "MOC"
	dir_check "$HOME/.moc/themes"
	make_symlink "$DOTFILES_DIR/moc/config" "$HOME/.moc/config"
	chmod 644 "$HOME/.moc/config" # Need to be not writable by other
	make_symlink "$DOTFILES_DIR/moc/dot_theme" "$HOME/.moc/themes/dot_theme"
fi

# Mplayer
# --------------------------------------------------------
if [[ -x "$(which mplayer 2>/dev/null)" ]]; then
	# Completion
	echo_header "Mplayer"
	make_symlink "$DOTFILES_DIR/mplayer/config" "$HOME/.mplayer/config"
	make_symlink "$DOTFILES_DIR/mplayer/input.conf" "$HOME/.mplayer/input.conf"
fi

# i3
# --------------------------------------------------------
if [[ -x "$(which i3 2>/dev/null)" ]]; then
	echo_header "i3"
	dir_check "$HOME/.i3"

	make_symlink "$DOTFILES_DIR/i3/conky_launcher" "$HOME/.i3/conky_launcher"
	chmod 770 "$HOME/.i3/conky_launcher"
	make_symlink "$DOTFILES_DIR/i3/conky_statusbar" "$HOME/.i3/conky_statusbar"

	SCREEN_COUNT=$(xrandr -q | grep ' connected' | wc -l)

	# Generated i3 config
	print_success "i3 config" "generated (screens : $SCREEN_COUNT)"

	echo -e "# DO NOT EDIT THIS FILE BY HAND.\n# YOUR CHANGES WILL BE OVERWRITTEN !\n" > "$I3_CONFIG_FILE"
	cat "$DOTFILES_DIR/i3/config_main" >> "$I3_CONFIG_FILE"

	if [[ "$SCREEN_COUNT" -gt 1 ]]; then
		# Dual screen
		make_symlink "$DOTFILES_DIR/i3/i3status_dual.conf" "$HOME/.i3/i3status.conf"
		cat "$DOTFILES_DIR/i3/config_bar_dual" >> "$I3_CONFIG_FILE"
	else
		# Simple screen
		make_symlink "$DOTFILES_DIR/i3/i3status.conf" "$HOME/.i3/i3status.conf"
		cat "$DOTFILES_DIR/i3/config_bar" >> "$I3_CONFIG_FILE"
	fi

	cat "$DOTFILES_DIR/i3/config_apps" >> "$I3_CONFIG_FILE"
fi

# Conky
# --------------------------------------------------------
if [[ -x "$(which conky 2>/dev/null)" ]]; then
	echo_header "Conky"
	make_symlink "$DOTFILES_DIR/conky/conkyrc" "$HOME/.conkyrc"
fi

# Newsbeuter
# --------------------------------------------------------
if [[ -x "$(which newsbeuter 2>/dev/null)" ]]; then
	echo_header "Newsbeuter"
	dir_check "$HOME/.newsbeuter"
	make_symlink "$DOTFILES_DIR/newsbeuter/config" "$HOME/.newsbeuter/config"
	make_symlink "$DOTFILES_DIR/newsbeuter/browse" "$HOME/.newsbeuter/browse"
	make_symlink "$DOTFILES_DIR/newsbeuter/urls" "$HOME/.newsbeuter/urls"
fi

# Virtualenvwrapper
# --------------------------------------------------------
if [[ -d "/data/dev/.virtualenvs" ]]; then
	echo_header "Virtualenv Hooks"
	make_symlink "$DOTFILES_DIR/virtualenvs/postactivate" "/data/dev/.virtualenvs/postactivate"
fi

# Sublime Text 3
# --------------------------------------------------------
if [[ -d "/opt/sublime_text" ]]; then
	echo_header "Sublime Text 3"
	make_symlink "$DOTFILES_DIR/sublime_text_3/Default (Linux).sublime-keymap" "$SUBLIMETEXT_CONF_DIR/Default (Linux).sublime-keymap"
	make_symlink "$DOTFILES_DIR/sublime_text_3/Preferences.sublime-settings" "$SUBLIMETEXT_CONF_DIR/Preferences.sublime-settings"
	make_symlink "$DOTFILES_DIR/sublime_text_3/Side Bar.sublime-settings" "$SUBLIMETEXT_CONF_DIR/Side Bar.sublime-settings"
	make_symlink "$DOTFILES_DIR/sublime_text_3/Markdown.sublime-settings" "$SUBLIMETEXT_CONF_DIR/Markdown.sublime-settings"
	make_symlink "$DOTFILES_DIR/sublime_text_3/PHP.sublime-settings" "$SUBLIMETEXT_CONF_DIR/PHP.sublime-settings"
	make_symlink "$DOTFILES_DIR/sublime_text_3/Python.sublime-settings" "$SUBLIMETEXT_CONF_DIR/Python.sublime-settings"
	make_symlink "$DOTFILES_DIR/sublime_text_3/YAML.sublime-settings" "$SUBLIMETEXT_CONF_DIR/YAML.sublime-settings"
	make_symlink "$DOTFILES_DIR/sublime_text_3/LaTeXTools.sublime-settings" "$SUBLIMETEXT_CONF_DIR/LaTeXTools.sublime-settings"
fi

# End
# --------------------------------------------------------
echo_header "End"
exit 0
